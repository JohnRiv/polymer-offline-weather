<!doctype html>
<!--
Copyright 2015 Google Inc. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Polymer Offline Weather</title>

    <link rel="manifest" href="../common/manifest.json">
    <meta name="theme-color" content="#006064">
    <link rel="icon" href="../common/icon.png">

    <script src="../bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <!-- TODO: Import the common elements -->

    <!-- See https://www.polymer-project.org/1.0/docs/devguide/styling.html#style-modules -->
    <!-- TODO: Include the shared styles from the common elements -->
  </head>

  <!-- TODO: Add Polymer's layout classes (i.e. Flexbox helpers) to the <body> tag.
       See https://elements.polymer-project.org/guides/flex-layout for a guide
       and https://github.com/PolymerElements/iron-flex-layout/blob/master/iron-flex-layout-classes.html
       for all of the available classes and what they do -->
  <body class="">
    <!-- TODO: create an auto-binding template with an id of "t" (that's what the <script> tag is looking for)
         See https://www.polymer-project.org/1.0/docs/devguide/templates#dom-bind -->
      <!-- TODO: Notice in the <script> below that this template has a "coordinates" property added to it.
           Create another template here that stamps its contents into the DOM
           only when the "coordinates" property becomes truthy.
           See https://www.polymer-project.org/1.0/docs/devguide/templates#dom-if -->
        <!-- TODO: inside of that conditional template, add
             <iron-ajax id="weather-ajax" loading="{{activeRequest}}"></iron-ajax> inside of it,
             and add additional attributes to that <iron-ajax> element to accomplish the following:
             - Automatically perform the Ajax request
             - Set the URL target of the request to the template's weatherApiUrl property
             - Set the query parameters for the URL target using the template's
               _calculateWeatherParams computing function
               ^ see https://www.polymer-project.org/1.0/docs/devguide/data-binding#annotated-computed
             - Store the reponse data as XHR.responseText parsed as JSON
             - Expose the lastResponse as "weatherResponse" so other elements can consume it
             See https://elements.polymer-project.org/elements/iron-ajax -->

      <!-- TODO: hide this <paper-progress> element if there is no active request
           See https://www.polymer-project.org/1.0/docs/devguide/templates#dom-if
           (but don't use dom-if, there's a better way! -->
      <paper-progress id="request-progress"
                      indeterminate>
      </paper-progress>

      <!-- TODO: Create another template here that wraps the remaining HTML content and
           stamps its contents into the DOM only when the weatherResponse" property becomes truthy. -->
        <div class="horizontal justified layout">
          <h3 id="location">
            Weather for
            <!-- TODO: in this <span>, use the the template's _calculateLocationString computing function
                 to display the properly formatted location.
                 The data for the location is available as weatherResponse.query.results.channel.location
                 See https://www.polymer-project.org/1.0/docs/devguide/data-binding#annotated-computed -->
            <span></span>
          </h3>
          <!-- TODO: If the user has denied geolocation permission or location data is currently being fetched,
               disable the "My Location" button.
               Hint: the logic in the <script> tag below exposes a property that has that logic built already,
               you just have to use it here to disable it.
               See https://elements.polymer-project.org/elements/paper-icon-button -->
          <paper-icon-button icon="maps:my-location"
                             alt="Detect current location"
                             on-click="_getCurrentPosition">
          </paper-icon-button>
        </div>

        <!-- TODO: Display the appropriate icon based on the response's condition code, which is available as
             weatherResponse.query.results.channel.item.condition.code
             The _calculateWeatherIcon computing function with give you the name of the icon to use
             See https://elements.polymer-project.org/elements/paper-icon-button -->
        <iron-icon id="weather-icon">
        </iron-icon>

        <h2>
          <span>[[weatherResponse.query.results.channel.item.condition.temp]]</span>Â°
          <span>[[weatherResponse.query.results.channel.units.temperature]]</span>,
          <span>[[weatherResponse.query.results.channel.item.condition.text]]</span>
        </h2>
        <div class="horizontal justified layout">
          <h5 id="update-time">
            As of <span>[[weatherResponse.query.results.channel.item.condition.date]]</span>
          </h5>
          <paper-icon-button icon="refresh"
                             alt="Refresh current weather"
                             disabled$="[[activeRequest]]"
                             on-click="_requestWeatherData">
          </paper-icon-button>
        </div>
        <a href="https://www.yahoo.com/?ilc=401" target="_blank">
          <img src="https://poweredby.yahoo.com/purple.png">
        </a>

    <script>
      var t = document.querySelector('#t');

      t.weatherApiUrl = 'https://query.yahooapis.com/v1/public/yql';

      // Use the lat/long for Mountain View, CA as the default location.
      t.defaultCoordinates = {
        latitude: 37.4209397,
        longitude: -122.0934599
      };

      t._getCurrentPosition = function() {
        t.disableLocationButton = true;
        navigator.geolocation.getCurrentPosition(function(position) {
          t.coordinates = position.coords;
          t.disableLocationButton = false;
        }, function(error) {
          t.coordinates = t.defaultCoordinates;
        });
      };

      t._requestWeatherData = function() {
        document.querySelector('#weather-ajax').generateRequest();
      };

      // See https://developer.yahoo.com/weather/
      t._calculateWeatherParams = function(latitude, longitude) {
        var latLongString = '(' + latitude + ',' + longitude + ')';
        return {
          format: 'json',
          q: 'select * from weather.forecast where woeid in ' +
             '(SELECT woeid FROM geo.places(1) WHERE text="' + latLongString + '")'
        };
      };

      // See https://developer.yahoo.com/weather/documentation.html#codes for a list of codes.
      // There are a few mismatches, limited by the set of weather-related Material Design icons.
      t._calculateWeatherIcon = function(code) {
        if (code <= 12 || code >= 37) {
          return 'image:flash-on';
        }

        if (code <= 18) {
          return 'image:flare';
        }

        if (code <= 30) {
          return 'image:wb-cloudy';
        }

        return 'image:wb-sunny';
      };

      t._calculateLocationString = function(location) {
        if (location.city && location.region) {
          return location.city + ', ' + location.region;
        }

        return location.city || 'Unknown';
      };

      // http://updates.html5rocks.com/2015/04/permissions-api-for-the-web
      if (navigator.permissions && navigator.permissions.query) {
        // If the Permissions Query API is available, let's use it!
        navigator.permissions.query({name: 'geolocation'}).then(function(permission) {
          if (permission.state === 'granted') {
            // If geolocation permissions were previously granted, then make a request for the
            // most recent position.
            t.activeRequest = true;
            t._getCurrentPosition();
          } else {
            // If we don't have geolocation permission (yet), use the default coordinates instead
            // of the real position.
            t.coordinates = t.defaultCoordinates;
            if (permission.state === 'denied') {
              // If the user has denied geolocation permission, disable the "My Location" button.
              t.disableLocationButton = true;
            }
          }

          permission.addEventListener('change', function(e) {
            if (e.target.state === 'denied') {
              // If the user has denied geolocation permission, disable the "My Location" button.
              t.disableLocationButton = true;
            }
          });
        });
      } else {
        // If the Permissions Query API isn't available, just use the default coordinates each time.
        // The "My Location" button can be used to obtain the real position.
        t.coordinates = t.defaultCoordinates;
      }
    </script>
  </body>
</html>
